FROM node:20 AS builder

# Update package lists and install git and ca-certificates
RUN apt-get update && apt-get install -y git ca-certificates

# Increase git buffer size
RUN git config --global http.postBuffer 1048576000

# don’t run as root
USER node

# run the app in a folder owned by the node user
WORKDIR /usr/src/build

# install build dependencies
COPY --chown=node:node *.json ./
RUN npm install

# get the build source
COPY --chown=node:node *.js ./
COPY --chown=node:node custom_typings custom_typings
COPY --chown=node:node src src
COPY --chown=node:node public public

# confirm the source
RUN ls -l /usr/src/build

# customize build for use with machinelearningforkids.co.uk
# TODO - how can this be provided to buildruns dynamically?
ENV DEPLOYMENT=mlforkids.ddns.net

# run the build
RUN ./node_modules/.bin/gulp buildprod

# confirm the built app details
RUN ls -l /usr/src/build

# prepare app image
FROM node:20

# don’t run as root
USER node

# run the app in a folder owned by the node user
WORKDIR /usr/src/app

# install runtime dependencies
COPY --chown=node:node package*.json ./
RUN npm clean-install --omit=dev

# setup supporting files
RUN mkdir logs
COPY --chown=node:node resources resources

# copy across built front-end code
RUN mkdir web
COPY --from=builder --chown=node:node /usr/src/build/web/static web/static
COPY --from=builder --chown=node:node /usr/src/build/web/dynamic web/dynamic
COPY --chown=node:node resources/datasets web/static/datasets

# copy across built back-end code
RUN mkdir dist
COPY --from=builder --chown=node:node /usr/src/build/dist/lib dist/lib

# confirm prepared app
RUN ls -l /usr/src/app

CMD ["npm", "start"]
